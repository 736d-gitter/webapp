#!/bin/bash

set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function startDockerMachine {
  if [[ $(docker-machine ls dev -q) -ne "dev" ]]; then
    docker-machine create -d virtualbox dev --virtualbox-disk-size "30000" --virtual-hostonly-cidr "192.168.99.1/24" -virtualbox-memory "2048" || true
  else
    ## Start the box if it's stopped
    if [[ $(docker-machine ls --filter state=Stopped -q) = "dev" ]]; then
      docker-machine start dev
    fi
  fi
  eval "$(docker-machine env dev)"
}

function setupHostAliases {
  CURRENT_ALIAS=$(grep gitter-dev.local /etc/hosts|sed 's/ .*//')
  DEV_IP=$(docker-machine ip dev)
  if [[ "$CURRENT_ALIAS" != "$DEV_IP" ]]; then
    >&2 echo "Warning. Your current gitter-dev.local ($CURRENT_ALIAS) hostname does not match the docker-machine IP of $DEV_IP"
    read -p "Would you like to update your hostfile? [yN] " -n 1 -r
    echo
    if [[ "$REPLY" =~ ^[Yy]$ ]]; then
      if [[ -z "$CURRENT_ALIAS" ]]; then
        sudo /bin/sh -c "echo \"$DEV_IP gitter-dev.local\" >> /etc/hosts"
      else
        sudo /bin/sh -c "sed -i.bak \"s/.* gitter-dev.local */$DEV_IP gitter-dev.local/\" /etc/hosts"
      fi
    fi

  fi
}

function startDockerServices {
  docker-compose up -d --no-recreate
}

function setupRedisConfigs {
  DEV_IP=$(docker-machine ip dev)
  mkdir -p "$SCRIPT_DIR/config/redis-docker/"

  cat <<EOD > "$SCRIPT_DIR/config/redis-docker/redis-sentinel.conf"
  sentinel monitor gitter-master-dev $DEV_IP 6379 1
  sentinel down-after-milliseconds gitter-master-dev 5000
  sentinel failover-timeout gitter-master-dev 30000
  sentinel config-epoch gitter-master-dev 3
  # Generated by CONFIG REWRITE
  bind 0.0.0.0
  port 26379
EOD

  cat <<EOD > "$SCRIPT_DIR/config/redis-docker/slave.conf"
  slaveof $DEV_IP 6379
EOD
}

function setupMongoInitScript {
  DEV_IP=$(docker-machine ip dev)
  mkdir -p "$SCRIPT_DIR/config/mongo-docker/"
  cat <<EOF > "$SCRIPT_DIR/config/mongo-docker/init-mongo.sh"
  mongo $DEV_IP/admin "/mongo-docker/init-replicaset.js"
  sleep 5
  ls -la /scripts/
  "/scripts/dataupgrades/001-oauth-client/002-add-redirect-uri.sh" "$DEV_IP/gitter"
EOF

  cat <<EOF > "$SCRIPT_DIR/config/mongo-docker/init-replicaset.js"
    try {
      rs.conf();
    } catch(e) {
      var cfg = {
          "_id": "troupeSet",
          "version": 1,
          "members": [
              {
                  "_id": 0,
                  "host": "${DEV_IP}:27017",
                  "priority": 2
              },
              {
                  "_id": 1,
                  "host": "${DEV_IP}:27018",
                  "priority": 1
              },
              {
                  "_id": 2,
                  "host": "${DEV_IP}:27019",
                  "priority": 1,
                  "arbiterOnly": true
              }
          ]
      };
      rs.initiate(cfg);
    }
EOF
}

startDockerMachine
setupHostAliases
setupRedisConfigs
setupMongoInitScript
startDockerServices

cat << "EOD"
# Run this command to configure your shell:
# eval "$(docker-machine env dev)"
EOD
