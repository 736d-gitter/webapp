!function(t){function e(t,e,n){var i,a;return function(){var r=Date.now();i&&i+e>r?(clearTimeout(a),a=setTimeout(function(){i=r,t.apply(n)},e)):(i=r,t.apply(n))}}function n(t,e){return t.bind?t.bind(e):function(){var n=Array.prototype.slice.call(arguments);t.apply(e,n)}}function i(t){this._callback=t,this._onModifications=e(function(){this._callback([])},5,this)}function a(t,e,n){this.element=t,this.callback=e,this.context=n,t.addEventListener("load",this,!1),t.addEventListener("error",this,!1)}function r(t){var e=!(1!==t.nodeType||"IMG"!==t.tagName||t.complete||t.getAttribute("width")&&t.getAttribute("height"));return e}function o(t,e){return t.dataset?t.dataset[e]:t.getAttribute("data-"+e)}function s(t,e,n){return t.dataset?void(t.dataset[e]=n):t.setAttribute("data-"+e,n)}function d(t,e){return t.dataset?void delete t.dataset[e]:void t.removeAttribute(attrName)}function c(t,i,a){this._eventHandlers={};var r=a?a.scope:null,o=a?a.timeout:0,s=this;this._callback=o?e(function(){try{i.apply(r)}finally{s.takeRecords()}},o):function(){try{i.apply(r)}finally{s.takeRecords()}},this._findLoadingImages(t),this._mutationCallback=n(this._mutationCallback,this),this.observer=new u(this._mutationCallback),this.observer.observe(t,{attributes:!0,childList:!0,characterData:!0,subtree:!0})}i.prototype={observe:function(t){this._target=t,t.addEventListener("DOMSubtreeModified",this._onModifications,!1)},disconnect:function(){this._target&&(this._target.removeEventListener("DOMSubtreeModified",this._onModifications,!1),delete this._target)},takeRecords:function(){var t=this._target;this._target&&(t.removeEventListener("DOMSubtreeModified",this._onModifications,!1),t.addEventListener("DOMSubtreeModified",this._onModifications,!1))}},a.prototype={_detach:function(){this.element&&(this.element.removeEventListener("load",this,!1),this.element.removeEventListener("error",this,!1),this.element=null,this.callback=null,this.context=null)},handleEvent:function(t){this.callback.call(this.context,t,this)}};var l=t.document,u=t.MutationObserver||t.MozMutationObserver||t.WebKitMutationObserver||i,h=0;return c.prototype={_addListener:function(t){if(!o(t,"gLoadListenerId")){var e=++h;s(t,"gLoadListenerId",e),this._eventHandlers[e]=new a(t,function(t,e){e._detach(),this._callback()},this)}},_removeListener:function(t){var e=o(t,"gLoadListenerId");if(e){d(t,"gLoadListenerId");var n=this._eventHandlers[e];n&&(delete this._eventHandlers[e],n._detach())}},_mutationCallback:function(t){var e=this;t.forEach(function(t){var n;if("childList"===t.type){if(t.addedNodes)for(var i=0;i<t.addedNodes.length;i++)n=t.addedNodes[i],1===n.nodeType&&(n.children.length?e._findLoadingImages(n):r(n)&&e._addListener(n));if(t.removedNodes)for(var a=0;a<t.removedNodes.length;a++)n=t.removedNodes[a],1===n.nodeType&&(n.children.length||"IMG"===n.tagName&&e._removeListener(n))}}),this._callback()},_findLoadingImages:function(t){for(var e=l.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null,!1);e.nextNode();){var n=e.currentNode;r(n)&&this._addListener(n)}},takeRecords:function(){return this.observer.takeRecords()},disconnect:function(){this.observer.disconnect();var t=this._eventHandlers;Object.keys(t).forEach(function(e){var n=t[e];n&&(delete t[e],n._detach())})}},t.Mutant=c,"function"==typeof define&&define.amd&&define([],function(){return c}),c}(window);
