<!DOCTYPE html>
<html>
<head>
    <title>Admin</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js" type="text/javascript"></script>
    <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="js/jquery.watable.js" type="text/javascript" charset="utf-8"></script>
    <link rel='stylesheet' href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css"/>
    <link rel='stylesheet' href='css/watable.css'/>
    <style type="text/css">
        body { padding: 30px; font-size: 12px }
    </style>
</head>
<body>

<h2>Currently Online</h2>
<div id="online" style="width:400px"></div>

<h2>Currently Mobile</h2>
<div id="mobile" style="width:400px"></div>


<h2>Open Sockets</h2>
<div id="sockets" style="width:400px"></div>


<script type="text/javascript">
    $(document).ready( function() {

        var onlineUsersTable = $('#online').WATable({}).data('WATable');
        $.get('/api/v1/online', function(data) {
            var data ={
                cols: getUserColumns(),
                rows: data.map(mapUserRows),
            };

            onlineUsersTable.setData(data);  //Sets the data.
        });

        var mobileUsersTable = $('#mobile').WATable({}).data('WATable');
        $.get('/api/v1/mobile', function(data) {
            var data ={
                cols: getUserColumns(),
                rows: data.map(mapUserRows),
            };

            mobileUsersTable.setData(data);  //Sets the data.
        });



        var openSocketsTable = $('#sockets').WATable({}).data('WATable');
        $.get('/api/v1/sockets', function(data) {
            var data ={
                cols: merge(
                        prefix('user_', getUserColumns()),
                        prefix('troupe_', getTroupeColumns()),
                        {
                            eyeballs: {
                                type: "boolean",
                                friendly: "Eyeballs"
                            },
                            mobile: {
                                 type: "boolean",
                                 friendly: "Mobile"
                            },
                            createdTime: {
                                type: "date",
                                friendly: "Created"
                            }
                        }
                      ),
                rows: data.map(function(row) {
                    return merge(
                        prefix('user_', mapUserRows(row.user)),
                        prefix('troupe_', mapTroupeRows(row.troupe)),
                        row
                    );
                }),
            };

            openSocketsTable.setData(data);  //Sets the data.
        });

        function prefix(prefix, columns) {
            if(!prefix) return columns;

            var o = {};
            for(var key in columns) {
                if(columns.hasOwnProperty(key)) {
                    o[prefix + key] = columns[key];
                }
            }

            return o;
        }

        function merge() {
            var o = {};
            for(var i = 0; i < arguments.length; i++) {
                var obj = arguments[i];
                for(var key in obj) {
                    if(obj.hasOwnProperty(key)) {
                        o[key] = obj[key];
                    }
                }

            }

            return o;
        }

        function getUserColumns() {
            return {
                id: {
                    type: "string",
                    friendly: "UserID"
                },
                name: {
                    type: "string",
                    friendly: "User Name"
                },
                location: {
                    type: "string",
                    friendly: "Location"
                }
            };
        }


        function getTroupeColumns() {
            return {
                id: {
                    type: "string",
                    friendly: "TroupeID"
                },
                name: {
                    type: "string",
                    friendly: "Troupe Name"
                },
                oneToOne: {
                    type: "boolean",
                    friendly: "One-to-one"
                }
            };
        }

        function mapUserRows(row) {
            return {
                id: row.id,
                name: row.displayName,
                location: row.location && row.location.description
            };
        }

        function mapTroupeRows(row) {
            return {
                id: row.id,
                name: row.name,
                oneToOne: row.oneToOne
            };
        }
    });
</script>
</body>
</html>